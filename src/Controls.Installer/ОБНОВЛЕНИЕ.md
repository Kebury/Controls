# Инструкция по обновлению Controls

## 🔄 Процесс обновления с сохранением данных

Инсталятор Controls автоматически определяет установленную версию и предлагает три варианта действий:

### 1. ✅ Обновление (Рекомендуется)
**Что происходит:**
- Устанавливаются новые файлы приложения
- **База данных сохраняется полностью**
- Создается резервная копия БД (опционально, если выбрана галочка)
- При первом запуске приложение автоматически обновляет структуру БД через миграции EF Core
- Все данные (задания, исполнители, отделы, уведомления) остаются нетронутыми

**Когда использовать:**
- Обычное обновление на новую версию
- Нужно сохранить все данные

**Рекомендации:**
- ✅ **Всегда выбирайте "Создать резервную копию базы данных"** для дополнительной безопасности
- ✅ Закройте приложение перед обновлением (инсталятор закроет автоматически)

### 2. 🔄 Переустановка
**Что происходит:**
- Полное удаление старой версии включая базу данных
- Чистая установка новой версии
- Все данные будут потеряны

**Когда использовать:**
- При серьезных проблемах с работой приложения
- Для полного "сброса" приложения
- Когда нужно начать с чистой базы данных

### 3. ❌ Только удалить
**Что происходит:**
- Удаление приложения без установки новой версии

## 🗄️ Миграции базы данных

### Автоматическое обновление структуры БД

При первом запуске после обновления:

1. Приложение проверяет наличие неприменённых миграций
2. Автоматически создает резервную копию БД в `%PROGRAMFILES%\Controls\database\backups\`
3. Показывает диалоговое окно с информацией о миграциях
4. После подтверждения применяет миграции через Entity Framework Core
5. Все данные сохраняются, обновляется только структура таблиц

### Список миграций

В текущей версии присутствуют следующие миграции:

1. `20260203142232_InitialCreate` - Начальная структура БД
2. `20260203174036_AddIsForcedCompletedToDepartmentTask` - Добавлено поле IsForcedCompleted
3. `20260218081457_AddLastOsNotificationSentField` - Добавлено поле LastOsNotificationSent
4. `20260219182400_AddAppSettings` - Добавлена таблица настроек приложения

### Резервные копии

**Где хранятся:**
- Инсталятор: `%PROGRAMFILES%\Controls\database_backups\`
- Приложение: `%PROGRAMFILES%\Controls\database\backups\`

**Формат имени:**
- Инсталятор: `backup_YYYYMMDD_HHMMSS\`
- Приложение: `Controls_backup_YYYYMMDD_HHMMSS.db`

**Автоочистка:**
- Приложение хранит последние 5 резервных копий
- Старые копии удаляются автоматически

## 🔧 Восстановление из резервной копии

Если после обновления возникли проблемы:

### Через файловую систему:

1. Закройте приложение Controls
2. Перейдите в `%PROGRAMFILES%\Controls\database\`
3. Переименуйте текущий файл `Controls.db` в `Controls.db.old`
4. Скопируйте файл резервной копии из папки `backups\`
5. Переименуйте его в `Controls.db`
6. Также скопируйте файлы `-wal` и `-shm` если они есть
7. Запустите приложение

### Через полную переустановку:

1. Скопируйте папку `database\` в безопасное место (например, на рабочий стол)
2. Запустите инсталятор и выберите "Переустановить"
3. После установки замените новую папку `database\` на сохраненную копию
4. Запустите приложение

## 📋 Требования к системе

- Windows 10/11 (64-bit)
- .NET 8.0 Runtime или выше
- Права администратора для установки
- ~100 МБ свободного места на диске

## ⚠️ Важные замечания

1. **Всегда закрывайте приложение перед обновлением**
   - Инсталятор попытается закрыть автоматически
   - Если приложение не закрывается, закройте вручную через диспетчер задач

2. **Резервные копии - ваш друг**
   - Всегда создавайте резервную копию при обновлении
   - Проверяйте наличие копий в папке backups

3. **Сетевые БД требуют особого внимания**
   - Если БД на сетевом диске, убедитесь что все пользователи закрыли приложение
   - Резервная копия создается локально на сервере

4. **Миграции применяются автоматически**
   - Entity Framework Core безопасно обновляет структуру
   - Данные не теряются, только добавляются новые поля/таблицы
   - Откат невозможен - поэтому важны резервные копии

## 📞 Поддержка

При возникновении проблем:

1. Проверьте папку `logs\` в каталоге установки
2. Проверьте наличие резервных копий в `database\backups\`
3. Попробуйте восстановиться из резервной копии
4. Обратитесь к системному администратору

---

**Версия документа:** 1.0  
**Дата:** 20.02.2026  
**Отдел Криминалистики**
